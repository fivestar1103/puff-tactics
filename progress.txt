# Puff Tactics â€” Progress Log
# Each entry records what was completed per Ralph loop iteration.
# Format: [date] US-XXX: summary

# --- Project initialized ---
# [2026-02-14] Project structure created. Godot 4 project.godot configured.
# PRD with 20 user stories covering M1-M6 scope. Ralph loop ready.
[2026-02-14] US-001: Added core constants and signal bus scripts, registered both as autoload singletons in project.godot, and updated PRD pass state.
[2026-02-14] US-002: Added BattleMap.tscn with TileMapLayer and implemented battle_map.gd for isometric terrain rendering, per-cell terrain data/effects, and dictionary+JSON map loading for procedural configs; updated PRD pass state.
[2026-02-14] US-003: Added PuffData resource schema with element affinity multipliers, created Puff.tscn + puff.gd for tilemap-positioned placeholder puffs, defined six base puff resource presets (Cloud/Flame/Droplet/Leaf/Whirl/Star), and validated scripts/resources via headless Godot checks.
[2026-02-14] US-004: Implemented turn_manager.gd with clean player_select/player_action/enemy_action/resolve transitions, side-based turn order, tap-driven puff selection, highlighted movement range, move and attack actions, and resolve/advance flow; added TurnBattle.tscn to wire BattleMap with playable turn interactions; validated runtime phase progression headlessly and re-ran Godot --check-only across all src/scripts .gd files.
[2026-02-14] US-005: Added battle bump_system.gd and integrated bump actions into turn_manager.gd for player/enemy turns, including adjacency-based push direction, chain bumps, cliff-fall 1-turn stun removal/recovery, and animated push/fall feedback; verified chain+cliff bump outcomes with a headless runtime script and re-ran Godot --check-only on all src/scripts .gd files.
[2026-02-14] US-006: Added ai/enemy_intent.gd and wired it into TurnBattle.tscn to render ghosted enemy intent overlays (move arrows, attack target highlights, skill-area previews). Refactored TurnManager to expose get_enemy_intent_snapshot() and execute enemy turns from the same intent plan for display/action parity. Verified all src/scripts .gd files with Godot --check-only and validated reactive intent recalculation via a headless runtime scenario after board-state changes.
[2026-02-14] US-007: Added ai/utility_ai.gd and integrated it into TurnManager so each enemy now evaluates legal wait/move/attack/skill actions and selects the highest utility score using weighted factors (attack value, survival risk, positional advantage, bump opportunity). Exposed AI weight multipliers as TurnManager exports for difficulty tuning, preserved intent-execution parity by reusing the same planning path for get_enemy_intent_snapshot(), and validated behavior with headless Godot syntax checks plus runtime checks for intent utility fields and action scoring.
[2026-02-14] US-008: Added FeedMain.tscn + feed_main.gd as the feed-first app entry with vertical swipe-up/swipe-down gesture navigation, smooth tween snap transitions between feed cards, and bottom profile/create/leaderboard FAB buttons. Each feed card now instantiates a TurnBattle snapshot (map + demo puffs + enemy intent overlay), with battle tap input disabled so cards behave as feed snapshots. Validated all src/scripts/*.gd files with Godot --check-only and confirmed project boot parsing with headless Godot --quit.
[2026-02-14] US-009: Added src/scripts/feed/feed_item.gd to run playable one-turn feed puzzles from snapshot data (map config, puff placements, seeded enemy intents), with a 15-30s decision window, 3s result animation phase, and 2s score/comparison screen before unlocking swipe-up. Refactored feed_main.gd to instantiate FeedItem cards, enable only the active card for interaction, and block feed swipes until the active puzzle cycle completes. Extended enemy_intent.gd with snapshot intent seeding so authored intent overlays display on load before reactive recalc takes over.
[2026-02-14] US-010: Added src/scripts/utils/puzzle_generator.gd with four difficulty-scaled templates (bump-to-cliff-kill, defeat-N-in-1-turn, heal-all-allies, minimum-moves), internal one-turn action simulation for solvability auto-validation, and JSON-safe feed snapshot output including puzzle_meta validation details. Re-ran headless Godot --check-only across all src/scripts/*.gd files and executed a headless smoke test confirming all templates generate solvable JSON-roundtrippable snapshots.
[2026-02-14] US-011: Added src/scripts/network/supabase_client.gd and registered it as a SupabaseClient autoload with project settings for URL/publishable key. Implemented auth-aware HTTPRequest wrappers for Supabase REST/auth endpoints, guest-mode UUID generation persisted locally, Apple Sign-In integration stub for iOS token handoff, encrypted auth state persistence in user://auth/supabase_auth.dat, and automatic access-token refresh via timer plus pre-request validation. Re-ran HOME=/tmp godot --headless --check-only across all src/scripts/*.gd and validated headless project startup with --quit.
[2026-02-14] US-012: Added src/scripts/network/feed_sync.gd to fetch Supabase feed_items in 50-item batches, normalize snapshot payloads for runtime, persist feed cache/pending result queues as JSON under user://feed_cache/, and retry queued feed_results uploads when connectivity/auth is available. Refactored src/scripts/feed/feed_main.gd to load/render cached feed snapshots immediately on app open, use fallback bundled snapshots only when cache is empty, and trigger non-blocking background fetch of the next batch while retaining offline cached playability. Wired feed item completion callbacks to submit score payloads through FeedSync after each solved item.
[2026-02-14] US-013: Added src/scenes/battle/FullBattle.tscn + src/scripts/battle/full_battle.gd to run multi-turn full matches with a pre-battle roster picker (3-4 puffs), elimination and majority tile-control win conditions, turn-limit resolution, JSON battle-log persistence to user://battle_logs for decisive-moment extraction, and victory/defeat rewards overlay. Extended src/scripts/core/turn_manager.gd with auto_begin_turn_cycle and begin_turn_cycle()/end_battle() hooks so FullBattle can start after team selection and end on external objectives. Verified via headless FullBattle scene/load-log smoke scripts plus HOME=/tmp Godot --check-only across all src/scripts/*.gd files.
[2026-02-14] US-014: Added src/scripts/utils/moment_extractor.gd to analyze full battle logs and pick decisive turns using the required criteria (HP swing >= 30%, knockout occurred, unique skill changed outcome), then package the selected turn as a feed-compatible snapshot containing pre-turn map state, puff positions, enemy intents, and original player action/result metadata. Extended src/scripts/core/turn_manager.gd with an action_resolved signal that emits structured move/attack/skill outcomes and updated src/scripts/battle/full_battle.gd to persist per-turn player snapshots and action/result summaries into battle logs (`turn_summaries`) for deterministic extraction. Verified with HOME=/tmp Godot --headless --check-only across all src/scripts/*.gd files and a headless runtime smoke test (`MOMENT_EXTRACTOR_SMOKE_OK`) exercising snapshot extraction from synthetic battle-log data.
[2026-02-14] US-015: Added src/scripts/network/pvp_async.gd to handle async PvP ghost lifecycle (upload opponent-team/AI snapshots after battles, matchmaking from leaderboards within an ELO window, Supabase result posting, and ELO updates for player/opponent profiles). Integrated src/scripts/battle/full_battle.gd to run matchmaking before battle start, apply matched ghost roster + AI weights for local enemy execution, and trigger post-battle ghost/result sync while keeping JSON battle-log generation available for decisive-moment extraction. Re-ran HOME=/tmp Godot --headless --check-only across all src/scripts/*.gd files and validated async match roster resolution with a headless FullBattle smoke script (PVP_ASYNC_SMOKE_OK).
[2026-02-14] US-016: Implemented puff growth + accessories by adding AccessoryData resources (hat/scarf/ribbon bonuses), extending puff_data.gd with XP/level progression and level-scaled effective stat getters, and introducing PuffProgression autoload to award XP from SignalBus feed_item_completed and battle_ended events while applying starter accessory loadouts. Updated player puff spawns in turn_manager.gd/feed_item.gd/full_battle.gd to consume progression-aware runtime PuffData, added accessory overlay sprite layers to Puff.tscn/puff.gd for visible gear, and created src/scenes/ui/CollectionScreen.tscn + src/scripts/ui/collection_screen.gd opened from FeedMain profile FAB to show owned accessories, equipped slots, and level/XP stats. Verified with HOME=/tmp Godot --headless --check-only across all src/scripts/*.gd, headless project boot, and runtime smoke test (US016_SMOKE_OK).
