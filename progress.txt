# Puff Tactics â€” Progress Log
# Each entry records what was completed per Ralph loop iteration.
# Format: [date] US-XXX: summary

# --- Project initialized ---
# [2026-02-14] Project structure created. Godot 4 project.godot configured.
# PRD with 20 user stories covering M1-M6 scope. Ralph loop ready.
[2026-02-14] US-001: Added core constants and signal bus scripts, registered both as autoload singletons in project.godot, and updated PRD pass state.
[2026-02-14] US-002: Added BattleMap.tscn with TileMapLayer and implemented battle_map.gd for isometric terrain rendering, per-cell terrain data/effects, and dictionary+JSON map loading for procedural configs; updated PRD pass state.
[2026-02-14] US-003: Added PuffData resource schema with element affinity multipliers, created Puff.tscn + puff.gd for tilemap-positioned placeholder puffs, defined six base puff resource presets (Cloud/Flame/Droplet/Leaf/Whirl/Star), and validated scripts/resources via headless Godot checks.
[2026-02-14] US-004: Implemented turn_manager.gd with clean player_select/player_action/enemy_action/resolve transitions, side-based turn order, tap-driven puff selection, highlighted movement range, move and attack actions, and resolve/advance flow; added TurnBattle.tscn to wire BattleMap with playable turn interactions; validated runtime phase progression headlessly and re-ran Godot --check-only across all src/scripts .gd files.
[2026-02-14] US-005: Added battle bump_system.gd and integrated bump actions into turn_manager.gd for player/enemy turns, including adjacency-based push direction, chain bumps, cliff-fall 1-turn stun removal/recovery, and animated push/fall feedback; verified chain+cliff bump outcomes with a headless runtime script and re-ran Godot --check-only on all src/scripts .gd files.
[2026-02-14] US-006: Added ai/enemy_intent.gd and wired it into TurnBattle.tscn to render ghosted enemy intent overlays (move arrows, attack target highlights, skill-area previews). Refactored TurnManager to expose get_enemy_intent_snapshot() and execute enemy turns from the same intent plan for display/action parity. Verified all src/scripts .gd files with Godot --check-only and validated reactive intent recalculation via a headless runtime scenario after board-state changes.
[2026-02-14] US-007: Added ai/utility_ai.gd and integrated it into TurnManager so each enemy now evaluates legal wait/move/attack/skill actions and selects the highest utility score using weighted factors (attack value, survival risk, positional advantage, bump opportunity). Exposed AI weight multipliers as TurnManager exports for difficulty tuning, preserved intent-execution parity by reusing the same planning path for get_enemy_intent_snapshot(), and validated behavior with headless Godot syntax checks plus runtime checks for intent utility fields and action scoring.
[2026-02-14] US-008: Added FeedMain.tscn + feed_main.gd as the feed-first app entry with vertical swipe-up/swipe-down gesture navigation, smooth tween snap transitions between feed cards, and bottom profile/create/leaderboard FAB buttons. Each feed card now instantiates a TurnBattle snapshot (map + demo puffs + enemy intent overlay), with battle tap input disabled so cards behave as feed snapshots. Validated all src/scripts/*.gd files with Godot --check-only and confirmed project boot parsing with headless Godot --quit.
[2026-02-14] US-009: Added src/scripts/feed/feed_item.gd to run playable one-turn feed puzzles from snapshot data (map config, puff placements, seeded enemy intents), with a 15-30s decision window, 3s result animation phase, and 2s score/comparison screen before unlocking swipe-up. Refactored feed_main.gd to instantiate FeedItem cards, enable only the active card for interaction, and block feed swipes until the active puzzle cycle completes. Extended enemy_intent.gd with snapshot intent seeding so authored intent overlays display on load before reactive recalc takes over.
[2026-02-14] US-010: Added src/scripts/utils/puzzle_generator.gd with four difficulty-scaled templates (bump-to-cliff-kill, defeat-N-in-1-turn, heal-all-allies, minimum-moves), internal one-turn action simulation for solvability auto-validation, and JSON-safe feed snapshot output including puzzle_meta validation details. Re-ran headless Godot --check-only across all src/scripts/*.gd files and executed a headless smoke test confirming all templates generate solvable JSON-roundtrippable snapshots.
[2026-02-14] US-011: Added src/scripts/network/supabase_client.gd and registered it as a SupabaseClient autoload with project settings for URL/publishable key. Implemented auth-aware HTTPRequest wrappers for Supabase REST/auth endpoints, guest-mode UUID generation persisted locally, Apple Sign-In integration stub for iOS token handoff, encrypted auth state persistence in user://auth/supabase_auth.dat, and automatic access-token refresh via timer plus pre-request validation. Re-ran HOME=/tmp godot --headless --check-only across all src/scripts/*.gd and validated headless project startup with --quit.
[2026-02-14] US-012: Added src/scripts/network/feed_sync.gd to fetch Supabase feed_items in 50-item batches, normalize snapshot payloads for runtime, persist feed cache/pending result queues as JSON under user://feed_cache/, and retry queued feed_results uploads when connectivity/auth is available. Refactored src/scripts/feed/feed_main.gd to load/render cached feed snapshots immediately on app open, use fallback bundled snapshots only when cache is empty, and trigger non-blocking background fetch of the next batch while retaining offline cached playability. Wired feed item completion callbacks to submit score payloads through FeedSync after each solved item.
[2026-02-14] US-013: Added src/scenes/battle/FullBattle.tscn + src/scripts/battle/full_battle.gd to run multi-turn full matches with a pre-battle roster picker (3-4 puffs), elimination and majority tile-control win conditions, turn-limit resolution, JSON battle-log persistence to user://battle_logs for decisive-moment extraction, and victory/defeat rewards overlay. Extended src/scripts/core/turn_manager.gd with auto_begin_turn_cycle and begin_turn_cycle()/end_battle() hooks so FullBattle can start after team selection and end on external objectives. Verified via headless FullBattle scene/load-log smoke scripts plus HOME=/tmp Godot --check-only across all src/scripts/*.gd files.
[2026-02-14] US-014: Added src/scripts/utils/moment_extractor.gd to analyze full battle logs and pick decisive turns using the required criteria (HP swing >= 30%, knockout occurred, unique skill changed outcome), then package the selected turn as a feed-compatible snapshot containing pre-turn map state, puff positions, enemy intents, and original player action/result metadata. Extended src/scripts/core/turn_manager.gd with an action_resolved signal that emits structured move/attack/skill outcomes and updated src/scripts/battle/full_battle.gd to persist per-turn player snapshots and action/result summaries into battle logs (`turn_summaries`) for deterministic extraction. Verified with HOME=/tmp Godot --headless --check-only across all src/scripts/*.gd files and a headless runtime smoke test (`MOMENT_EXTRACTOR_SMOKE_OK`) exercising snapshot extraction from synthetic battle-log data.
[2026-02-14] US-015: Added src/scripts/network/pvp_async.gd to handle async PvP ghost lifecycle (upload opponent-team/AI snapshots after battles, matchmaking from leaderboards within an ELO window, Supabase result posting, and ELO updates for player/opponent profiles). Integrated src/scripts/battle/full_battle.gd to run matchmaking before battle start, apply matched ghost roster + AI weights for local enemy execution, and trigger post-battle ghost/result sync while keeping JSON battle-log generation available for decisive-moment extraction. Re-ran HOME=/tmp Godot --headless --check-only across all src/scripts/*.gd files and validated async match roster resolution with a headless FullBattle smoke script (PVP_ASYNC_SMOKE_OK).
[2026-02-14] US-016: Implemented puff growth + accessories by adding AccessoryData resources (hat/scarf/ribbon bonuses), extending puff_data.gd with XP/level progression and level-scaled effective stat getters, and introducing PuffProgression autoload to award XP from SignalBus feed_item_completed and battle_ended events while applying starter accessory loadouts. Updated player puff spawns in turn_manager.gd/feed_item.gd/full_battle.gd to consume progression-aware runtime PuffData, added accessory overlay sprite layers to Puff.tscn/puff.gd for visible gear, and created src/scenes/ui/CollectionScreen.tscn + src/scripts/ui/collection_screen.gd opened from FeedMain profile FAB to show owned accessories, equipped slots, and level/XP stats. Verified with HOME=/tmp Godot --headless --check-only across all src/scripts/*.gd, headless project boot, and runtime smoke test (US016_SMOKE_OK).
[2026-02-14] US-017: Added src/scenes/ui/PuzzleEditor.tscn + src/scripts/ui/puzzle_editor.gd for UGC authoring with drag terrain paint and puff drag/drop placement, per-puff team/element/class controls, and win-condition template selection. Wired FeedMain Create FAB to open/close the editor and block feed swipe while editing; editor now runs FeedItem-based test-play before publish, requires the latest tested snapshot version, serializes authored snapshots to JSON-safe payloads, and uploads to Supabase `ugc_puzzles` via SupabaseClient. Extended feed_item.gd snapshot spawning to apply optional element/puff_class overrides so editor-authored puzzles test-play/render correctly. Verified via HOME=/tmp Godot --headless --check-only across all src/scripts/*.gd, headless project boot, and a runtime smoke check (US017_SMOKE_OK).
[2026-02-14] US-018: Added src/scripts/ui/puff_animator.gd with configurable Tween-based squash/stretch animation helpers for move bounce, attack inflate/squish, directional bump stretch+bounce, defeat deflate/fade, and heal glow+float feedback. Integrated TurnManager to use these animations during move/attack/bump resolution, added path-based move tweening across tiles, action-lock guards during animation playback, and heal-style recovery feedback when cliff-stunned puffs re-enter play. Verified with HOME=/tmp Godot --headless --check-only across all src/scripts/*.gd (22 scripts) and headless project boot (--quit).
[2026-02-14] US-019: Refactored src/scripts/feed/feed_item.gd score flow into a dedicated score/comparison overlay that computes final score from enemies defeated, damage dealt, puffs surviving, and turns used; added decisive-moment comparison messaging ("Did you do better than the original player?") via moment_meta data, micro-puzzle percentile ranking vs community score metadata/samples with fallback estimation, animated Tween-based count-up score reveal, and a Share button stub placeholder. Verified syntax by running HOME=/tmp Godot --headless --check-only for all src/scripts/*.gd.
[2026-02-14] US-020: Added src/scenes/story/StoryChapter1.tscn + src/scripts/story/story_chapter_1.gd for a 6-battle Chapter 1 campaign with scripted class-introduction progression (Cloud, Flame, Droplet, Leaf, Whirl, Star), inter-battle dialogue cards with generated portrait textures, and integrated tutorials (battle 1 move, battle 2 attack, battle 3 bump, battle 4 terrain). Extended src/scripts/battle/full_battle.gd with a scripted battle API (`start_scripted_battle`), battle/player-action signals for chapter orchestration, and scripted-mode controls for fixed map/roster runs without async PvP or internal result overlay. Added chapter completion rewards that unlock puffs/accessories through src/scripts/puffs/puff_progression.gd (`grant_story_chapter_rewards`) plus new accessory resources (`chapter_crown.tres`, `story_sash.tres`), surfaced story unlock state in collection_screen, and wired FeedMain leaderboard FAB to launch StoryChapter1. Verified modified scripts and story scene load using headless Godot --check-only / --scene runs.

[2026-02-14] US-021: Added global VisualTheme singleton with StyleBox helpers (panel, button styles, label/separator styling), registered it in project.godot autoload, and added required GDD palette/font/UI constants to constants.gd.

[2026-02-14] US-022: Increased Puff placeholder sprite to 128px with kawaii face features (eyes, curved mouth, blush), added 3px team-colored ring controlled by `team` on Puff, added bottom-right diamond element badge, scaled accessory textures to new placeholder size, and updated collision/sprite offsets and team assignments at spawn points so rings render correctly in turn feed, full battle, and editor contexts.
[2026-02-14] US-023: Added terrain indicator symbols and gradient shading in BattleMap tile atlas generation for all terrain types (cloud puff, high cloud arrow, candy swirl, puddle waves, cliff triangle, mushroom cap) plus thicker cliff border emphasis.

[2026-02-14] US-024: Redesigned the FeedMain UI by applying VisualTheme label/button styling: title/subtitle use themed fonts/colors, FAB buttons use PALETTE_SKY/PEACH/MINT with shared button theme helper, and added SwipeHintLabel at bottom center to indicate upward swipe progression.
[2026-02-14] US-025: Added HUD Layer to TurnBattle with TurnBanner/ScorePanel/ResultOverlay and new battle_hud.gd. HUD now updates on TurnManager phase changes, shows player/enemy turn banner states and displays semi-transparent victory/defeat overlay at battle end.
[2026-02-14] US-026: Enhanced enemy intent visuals by adding vivid directional arrows for move/skill actions, purple skill-area highlights, and red crosshair/X overlays for attack targets in `src/scripts/ai/enemy_intent.gd`. Updated PRD pass state and notes.
[2026-02-14] US-027: Added VisualTheme-based UI styling for CollectionScreen and PuzzleEditor: cream rounded panel backgrounds, lavender collection title, pink close action button, and color-coded puzzle editor action buttons (Apply Sky, Remove Pink, Clear Peach, TestPlay Mint, Publish Lavender).

[2026-02-14] US-028: Story dialogue and chapter complete screens now use VisualTheme-based panel/button/label styling via story_chapter_1.gd; dialogue panel and title text use cream/sky/peach/lavender palette accents, Next/Complete buttons are themed mint/lavender, and button styling is applied with pill-like radius for readability and consistency with GDD.
[2026-02-15] US-029: Updated FeedItem snapshot setup to suppress TurnBattle/HudLayer (CanvasLayer) so TurnBanner/Turn score HUD no longer renders over feed header UI, while leaving FullBattle HUD behavior unchanged. Validated with a headless FeedItem smoke check confirming HudLayer is present and hidden in feed context; attempted required screenshot capture via `bash ralph/take_screenshot.sh`, but this sandbox cannot initialize X11/Wayland display so visual capture is blocked here.
[2026-02-15] US-030: Increased FeedItem snapshot scale (`SNAPSHOT_SCALE` 0.68 -> 1.14) and added map-aware `_layout_battle_snapshot()` centering that applies a negative half-map-width X offset after loading map config, so the 5x5 isometric board is centered and larger within feed cards without tile clipping. Verified headless project boot (`godot --headless --quit`); attempted required screenshot verification via `bash ralph/take_screenshot.sh` (plus HOME=/tmp and Xvfb fallback), but this sandbox cannot initialize X11/Wayland display so visual capture is blocked here.
[2026-02-15] US-032: Updated `src/scripts/feed/feed_main.gd` fallback feed snapshots to 2v2 minimum unit composition and added runtime snapshot normalization so cached/remote items are enforced to at least 2 player + 2 enemy puffs on unique cells with a fallback enemy intent when missing. Added a second player puff to `src/scripts/feed/feed_item.gd` DEFAULT_SNAPSHOT for standalone safety. Verified by headless runtime checks (`US032_VERIFY_OK`, `US032_SPAWN_VERIFY_OK`). Attempted required screenshot capture via `bash ralph/take_screenshot.sh` (HOME=/tmp, xvfb, DISPLAY=:0 fallbacks), but this environment cannot initialize an X11/Wayland display, so visual screenshot validation remains blocked in this sandbox.
[2026-02-15] US-033: Ran a visual QA layout pass for the feed card by increasing snapshot scale and retuning status/score panel vertical offsets in `src/scripts/feed/feed_item.gd`, plus adding viewport-proportional HUD/FAB/swipe-hint layout in `src/scripts/feed/feed_main.gd` and nudging feed card placement lower (`SNAPSHOT_Y_RATIO` 0.40). Verified project parseability with `HOME=/tmp godot --headless --path /home/fives/projects/puff-tactics --scene src/scenes/feed/FeedMain.tscn --quit`. Required screenshot capture remains blocked in this sandbox (`bash ralph/take_screenshot.sh` cannot initialize X11/Wayland display drivers), so final visual acceptance remains pending.
[2026-02-15] US-033: Final feed visual QA retune: moved feed cards upward (`SNAPSHOT_Y_RATIO` 0.40 -> 0.34), raised swipe-hint placement (`SWIPE_HINT_GAP_RATIO` 0.10 -> 0.15, `SWIPE_HINT_GAP_MIN` 120 -> 150), and added `SNAPSHOT_LOCAL_Y` (+40px) in `src/scripts/feed/feed_item.gd` so centered map content sits in the middle lane without crowding header/FAB UI. Re-validated with headless scene boots for `FeedMain.tscn` and `TurnBattle.tscn`; required screenshot command (`HOME=/tmp bash ralph/take_screenshot.sh`) still fails in this sandbox because X11/Wayland display drivers are unavailable.
[2026-02-15] US-033: Reworked feed-card vertical composition using map-anchored layout in `feed_item.gd` (status panel now sits ~30px above map top, score panel ~24px below map bottom), moved snapshot stack upward (`SNAPSHOT_LOCAL_Y = -160`), lowered feed card origin (`SNAPSHOT_Y_RATIO = 0.22`), and added tall-viewport swipe-hint adjustment plus a visible pre-score panel to eliminate dead space in decision phase. Verified with headless `FeedMain.tscn` parse and coordinate probe outputs.
[2026-02-15] US-036: Screenshot QA showed the battle map still felt undersized and puff details were less legible, so `src/scripts/feed/feed_item.gd` `SNAPSHOT_SCALE` was increased from `1.28` to `1.52` (~83.1% of a 1170px viewport for a 5x5 128x64 isometric grid) while keeping existing map-bounds centering to avoid tile clipping. Verified with `HOME=/tmp godot --headless --path /home/fives/projects/puff-tactics --scene res://src/scenes/feed/FeedMain.tscn --quit`.
[2026-02-15] US-037: Tightened feed-card vertical flow based on screenshot QA by updating `src/scripts/feed/feed_item.gd` map-anchored spacing (`STATUS_PANEL_SIZE` 170->228, `STATUS_PANEL_MAP_GAP` 30->16, `SCORE_PANEL_MAP_GAP` 24->16) and retuning status label block layout, then reducing `src/scripts/feed/feed_main.gd` score/hint/FAB spacing (`SCORE_TO_SWIPE_HINT_GAP` 52->46, `SWIPE_HINT_TO_FAB_GAP` 66->64). Verified with headless layout probe (`subtitle->status ~55.5px`, `status->map ~16px`, `map->score ~16px`, `score->swipe ~46px`, `swipe->FAB ~64px`) and headless scene parse for `FeedMain.tscn`.
[2026-02-15] US-039: Fixed first-frame feed HUD spacing regression by adding a deferred `_layout_hud_overlays()` pass in `src/scripts/feed/feed_main.gd` after initial card activation, ensuring swipe hint/FAB placement uses the active `FeedItem` score panel bounds instead of fallback bottom anchors. This addresses the large empty middle lane seen in screenshot QA and tightens status->map->score->hint->FAB vertical flow. Updated `ralph/prd.json` (US-039 pass + notes), and documented the layout-order gotcha in `AGENTS.md`.
[2026-02-18] US-039: Fixed screenshot-driven feed composition regression by moving the feed card stack into the primary viewport lane (`src/scripts/feed/feed_main.gd` `SNAPSHOT_Y_RATIO` 0.46 -> 0.18), eliminating the oversized subtitle->status dead zone seen in QA screenshots. Also reduced battle snapshot overfill pressure (`src/scripts/feed/feed_item.gd` `SNAPSHOT_SCALE` 1.65 -> 1.46) to keep the map prominent while easing edge crowding. Verified with `HOME=/tmp godot --headless --path /home/fives/projects/puff-tactics --scene res://src/scenes/feed/FeedMain.tscn --quit`.
[2026-02-18] US-039: Applied a screenshot-driven visual polish pass focused on style (not layout constants): upgraded feed status/score cards to rounded elevated panels with better contrast/shadows and larger score typography, added a soft map backdrop frame in `feed_item.gd`, refreshed player-facing status/preview copy, and introduced atmospheric background/header/FAB styling in `feed_main.gd` (pastel blobs, header card treatment, elevated FAB states). Updated PRD US-039 to pass and verified with `HOME=/tmp godot --headless --path /home/fives/projects/puff-tactics --scene res://src/scenes/feed/FeedMain.tscn --quit`.
[2026-02-18] US-040: Screenshot QA highlighted placeholder/implementation-detail feed copy, so feed text was cleaned to player-facing language only. Updated `feed_item.gd` score preview (`Go!` -> `Ready`) plus friendlier preview guidance, refreshed `feed_main.gd` subtitle and edge-case button feedback to remove technical wording, and updated `FeedMain.tscn` defaults (`Puff Tactics`, clearer subtitle/swipe hint). Verified parse with `HOME=/tmp godot --headless --path /home/fives/projects/puff-tactics --scene res://src/scenes/feed/FeedMain.tscn --quit`.
[2026-02-18] US-041: Screenshot QA showed status/score/FAB surfaces still looked flat, so feed card elevation was standardized: `feed_item.gd` now uses a shared 26px-radius card style for status/score panels with consistent 2px pastel borders and subtle shadow (size 10, y-offset 3, alpha 0.12), and `feed_main.gd` FAB state styleboxes were aligned to the same softer shadow/border treatment. Verified parse with `HOME=/tmp godot --headless --path /home/fives/projects/puff-tactics --scene res://src/scenes/feed/FeedMain.tscn --quit`.
[2026-02-18] US-042: Screenshot QA showed the FAB row reading faint and not clearly pill-shaped, so `feed_main.gd` now uses explicit FAB min-size constants (Profile/Leaderboard 170x74, Create 212x88), computes corner radius from each button height (height/2) for true pills, adds per-state subtle drop-shadow elevation, applies 18px horizontal + 12px vertical content padding, and strengthens primary Create hierarchy with larger size/color/font treatment. Verified parse with `HOME=/tmp godot --headless --path /home/fives/projects/puff-tactics --scene res://src/scenes/feed/FeedMain.tscn --quit`.
[2026-02-18] US-043: Applied typography hierarchy pass for feed readability based on screenshot QA. Updated `feed_item.gd` status and score text scales/opacities (status 33/22, score 29/52/19/21) and tuned `feed_main.gd` header emphasis plus low-emphasis swipe hint (18px @ 0.62 alpha). Reduced FAB label sizes to 20/22/20 for clearer visual hierarchy. Verified parse with `HOME=/tmp godot --headless --path /home/fives/projects/puff-tactics --scene res://src/scenes/feed/FeedMain.tscn --quit`.
