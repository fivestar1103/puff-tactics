{
  "name": "Puff Tactics",
  "branchName": "main",
  "description": "Tactical feed game for iOS. Feed-first micro-puzzle gameplay with bump mechanics, async PvP, and procedural content generation. Built in Godot 4 with Supabase backend.",
  "qualityGates": [
    "All .gd scripts have no syntax errors",
    "Scene files have no broken references",
    "Commits are atomic (one story each)"
  ],
  "userStories": [
    {
      "id": "US-001",
      "title": "Core constants and autoloads",
      "description": "As a developer, I want a constants file and signal bus autoload so that all systems share common definitions.",
      "acceptanceCriteria": [
        "src/scripts/core/constants.gd exists with element enum (FIRE, WATER, GRASS, WIND, STAR), puff class enum, grid size constants, and color palette constants",
        "src/scripts/core/signal_bus.gd exists as an autoload with signals for feed_item_completed, puff_moved, puff_bumped, turn_ended, battle_ended",
        "Both are registered as autoloads in project.godot",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented core constants and signal bus autoload scripts; registered both singletons in project.godot. Godot/gdlint CLI unavailable in this environment, so syntax was validated by script review.",
      "dependsOn": []
    },
    {
      "id": "US-002",
      "title": "Isometric tilemap with terrain types",
      "description": "As a player, I want to see a 5x5 isometric tilemap with different terrain types so that I can understand the battlefield.",
      "acceptanceCriteria": [
        "src/scenes/maps/BattleMap.tscn exists with a TileMapLayer node using isometric tiles",
        "src/scripts/core/battle_map.gd handles tile data: terrain type (cloud, high_cloud, cotton_candy, puddle, cliff, mushroom) stored per cell",
        "Terrain effects defined per type matching GDD (high ground +1 attack, cliff = knockout on fall, etc.)",
        "Placeholder colored tiles distinguish each terrain type visually",
        "Map can be loaded from a dictionary/JSON config for procedural generation",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Added BattleMap scene with TileMapLayer and new battle_map.gd terrain system. Terrain types are stored per cell, effects are defined per GDD, and map loading supports dictionary and JSON configs. Placeholder isometric terrain tiles are generated with distinct colors at runtime. Godot/gdlint CLI is unavailable in this environment, so syntax was validated by static script review.",
      "dependsOn": [
        "US-001"
      ]
    },
    {
      "id": "US-003",
      "title": "Puff entity and class system",
      "description": "As a developer, I want puff entities with stats, elements, and classes so that gameplay can reference them.",
      "acceptanceCriteria": [
        "src/scripts/puffs/puff_data.gd resource class with: element, puff_class, move_range, attack_range, hp, attack, defense, unique_skill_id",
        "src/scripts/puffs/puff.gd scene script that displays a puff on the tilemap with placeholder sprite",
        "All 6 base puff classes defined as resources: Cloud(tank), Flame(melee), Droplet(ranged), Leaf(healer), Whirl(mobility), Star(wildcard)",
        "Element affinity system: damage multiplier lookup for element matchups",
        "src/scenes/puffs/Puff.tscn scene with Sprite2D + collision shape",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Implemented PuffData resource schema, Puff scene/script with tilemap positioning and placeholder rendering, six base class .tres resources (Cloud, Flame, Droplet, Leaf, Whirl, Star), and element affinity damage multipliers. Verified all .gd scripts parse via headless Godot --check-only script checks and verified puff resources/scene load headlessly. Also replaced non-constant PackedStringArray() usages in battle_map.gd to satisfy project-wide script parsing.",
      "dependsOn": [
        "US-001"
      ]
    },
    {
      "id": "US-004",
      "title": "Turn system and action selection",
      "description": "As a player, I want to select a puff and choose move/attack/skill actions during my turn so that I can make tactical decisions.",
      "acceptanceCriteria": [
        "src/scripts/core/turn_manager.gd manages turn order and phase (player_select, player_action, enemy_action, resolve)",
        "Tap a friendly puff to select it; show movement range as highlighted tiles",
        "Tap a valid tile to move; tap an enemy in attack range to attack",
        "After player acts, turn resolves and advances",
        "Turn state machine handles transitions cleanly",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Added turn_manager.gd with explicit phase transitions for player_select/player_action/enemy_action/resolve and side-based turn order. Added TurnBattle.tscn wiring BattleMap + TurnManager with tap-friendly puff selection, movement range tile highlights, tile tap movement, enemy tap attacks, and action resolve advancing to enemy then next player turn. Verified runtime phase progression in a headless TurnBattle script and verified all src/scripts .gd files parse with Godot --check-only (HOME=/tmp in this sandbox).",
      "dependsOn": [
        "US-002",
        "US-003"
      ]
    },
    {
      "id": "US-005",
      "title": "Bump mechanic (core push physics)",
      "description": "As a player, I want to push adjacent puffs so that chain bumps and cliff knockouts create tactical depth.",
      "acceptanceCriteria": [
        "src/scripts/battle/bump_system.gd handles bump logic",
        "Any puff can bump an adjacent opponent 1 tile away from the bumper",
        "Chain bumps: if A bumps B into C, C is also pushed",
        "Cliff knockout: puff pushed off a cliff tile gets 1-turn stun (removed from play for 1 turn)",
        "Bump direction follows grid adjacency rules for isometric layout",
        "Visual feedback: pushed puffs animate along the path",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Added src/scripts/battle/bump_system.gd to resolve adjacency-based bump direction, chained pushes, and cliff-fall outcomes. Integrated bump actions into turn_manager.gd for player and enemy turns with animated push/fall feedback, SignalBus puff_bumped emissions, and 1-turn cliff stun removal/recovery handling. Verified behavior with a headless runtime script for chain and cliff cases and re-ran Godot --check-only across all src/scripts/*.gd files.",
      "dependsOn": [
        "US-004"
      ]
    },
    {
      "id": "US-006",
      "title": "Enemy intent display (Into the Breach style)",
      "description": "As a player, I want to see what enemies plan to do next so that I make strategic decisions, not guesses.",
      "acceptanceCriteria": [
        "src/scripts/ai/enemy_intent.gd calculates and stores each enemy's planned action",
        "Semi-transparent overlay shows: move destination arrow, attack target highlight, skill area preview",
        "Intents update when player actions change the board state (reactive recalc)",
        "Visual style: ghosted/transparent icons on tiles matching GDD tone",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Added src/scripts/ai/enemy_intent.gd and wired it into TurnBattle.tscn as a ghosted overlay layer. TurnManager now exposes get_enemy_intent_snapshot() so intents are calculated/stored per enemy and reused by enemy action execution for parity. Overlay draws semi-transparent move arrows, attack target highlights, and skill-area previews (bump chain tiles), and intents recalc reactively on phase changes plus SignalBus board-state events. Verified with headless Godot --check-only across all src/scripts/*.gd files and a runtime script confirming intent updates after a player-position board change.",
      "dependsOn": [
        "US-004"
      ]
    },
    {
      "id": "US-007",
      "title": "Basic Utility AI for enemies",
      "description": "As the game, I want enemies to choose smart actions via utility scoring so that puzzles feel fair and challenging.",
      "acceptanceCriteria": [
        "src/scripts/ai/utility_ai.gd scores candidate actions per puff",
        "Scoring factors: attack value, survival risk, positional advantage, bump opportunity",
        "Each enemy evaluates all legal actions and picks highest score",
        "AI difficulty can be tuned via weight multipliers",
        "AI decisions feed into the enemy intent display system",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Added src/scripts/ai/utility_ai.gd for utility-based enemy decision scoring with tunable weight multipliers (attack_value, survival_risk, positional_advantage, bump_opportunity). Refactored TurnManager enemy planning to enumerate legal wait/move/attack/skill candidates per enemy, score all candidates, and pick the highest-utility intent for both enemy execution and get_enemy_intent_snapshot() overlay parity. Verified via headless Godot --check-only across all src/scripts/*.gd files and a runtime headless TurnBattle check confirming legal-candidate evaluation and selected-intent/utility-score parity.",
      "dependsOn": [
        "US-006"
      ]
    },
    {
      "id": "US-008",
      "title": "Vertical swipe feed UI",
      "description": "As a player, I want to swipe up through tactical snapshots like a social media feed so that the UX feels instant and addictive.",
      "acceptanceCriteria": [
        "src/scenes/feed/FeedMain.tscn is the main scene (app entry point)",
        "Vertical swipe gesture detection: swipe up = next item, swipe down = previous",
        "Feed items snap into place with smooth animation",
        "Each feed item contains a battle snapshot (map + puffs + enemy intents)",
        "Bottom FAB buttons for profile/create/leaderboard",
        "Portrait orientation locked",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Added FeedMain as the app entry scene with vertical swipe up/down gesture handling, tweened snap transitions between stacked feed cards, and bottom profile/create/leaderboard FABs. Each card instantiates TurnBattle snapshots (BattleMap + demo puffs + EnemyIntent overlay) with TurnManager input disabled so cards behave as feed snapshots. Verified script syntax with headless Godot --check-only across src/scripts/*.gd and verified project startup parses via headless Godot --quit.",
      "dependsOn": [
        "US-002",
        "US-003"
      ]
    },
    {
      "id": "US-009",
      "title": "Feed item: micro-puzzle gameplay loop",
      "description": "As a player, I want to play a 1-turn micro-puzzle from the feed, see results, get scored, and swipe to the next one.",
      "acceptanceCriteria": [
        "src/scripts/feed/feed_item.gd loads a puzzle snapshot (map config + puff positions + enemy intents)",
        "Player makes 1 turn of decisions (move/attack/bump for each friendly puff)",
        "Turn resolves with result animation (3 seconds per GDD)",
        "Score/comparison screen shown (2 seconds per GDD)",
        "Swipe up transitions to next feed item",
        "Full cycle: 20-35 seconds as specified in GDD",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Added src/scripts/feed/feed_item.gd to load puzzle snapshots (map config + puff positions + seeded enemy intents), run one-turn tactical interaction, enforce a 15-30s decision window, play a 3s result phase and 2s score/comparison phase, and emit feed completion scores. Refactored src/scripts/feed/feed_main.gd to instantiate FeedItem cards, activate one card at a time, and gate swipe transitions until the active cycle is complete. Extended src/scripts/ai/enemy_intent.gd with load_snapshot_intents() so feed snapshots can render authored intent overlays before reactive recalculation.",
      "dependsOn": [
        "US-005",
        "US-007",
        "US-008"
      ]
    },
    {
      "id": "US-010",
      "title": "Procedural puzzle generator",
      "description": "As the system, I want to auto-generate micro-puzzles from templates so that content never runs out.",
      "acceptanceCriteria": [
        "src/scripts/utils/puzzle_generator.gd creates puzzles from templates",
        "Templates: bump-to-cliff-kill, defeat-N-in-1-turn, heal-all-allies, minimum-moves",
        "Generator places puffs and terrain according to template + difficulty params",
        "Auto-validation: simulates to confirm puzzle is solvable",
        "Output: JSON-serializable puzzle snapshot ready for feed",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Added src/scripts/utils/puzzle_generator.gd with template-based generation for bump-to-cliff-kill, defeat-N-in-1-turn, heal-all-allies, and minimum-moves puzzles. Generator scales puzzle setup by difficulty, simulates legal player actions (move/attack/bump/heal) to auto-validate solvability, and returns feed-ready JSON-safe snapshots (map_config/puffs/enemy_intents/target_score plus puzzle_meta validation details). Verified all scripts with headless Godot --check-only and ran a headless smoke test that generated all four templates and round-tripped JSON serialization.",
      "dependsOn": [
        "US-005",
        "US-007"
      ]
    },
    {
      "id": "US-011",
      "title": "Supabase client and authentication",
      "description": "As a player, I want to sign in (or play as guest) so that my progress is saved.",
      "acceptanceCriteria": [
        "src/scripts/network/supabase_client.gd wraps HTTPRequest for Supabase REST API",
        "Guest mode: generates anonymous UUID, stores locally",
        "Apple Sign-In integration stub (ready for iOS export)",
        "Auth token stored securely and refreshed automatically",
        "All API calls include auth headers",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Implemented src/scripts/network/supabase_client.gd as a Supabase autoload HTTPRequest wrapper with auth-aware REST/auth helpers, local guest UUID identity, Apple Sign-In handoff stub for iOS plugin integration, encrypted auth state storage at user://auth/supabase_auth.dat, and automatic token refresh (timer + pre-request validation). Added project settings keys puff_tactics/supabase/url and puff_tactics/supabase/publishable_key in project.godot. Verified all src/scripts/*.gd via HOME=/tmp godot --headless --check-only.",
      "dependsOn": [
        "US-001"
      ]
    },
    {
      "id": "US-012",
      "title": "Feed data sync with Supabase",
      "description": "As the system, I want to fetch feed items from Supabase and cache them locally so that app open = 0-second load.",
      "acceptanceCriteria": [
        "src/scripts/network/feed_sync.gd fetches feed_items from Supabase in batches of 50",
        "Local cache: feed items stored as JSON in user://feed_cache/",
        "On app open: render from cache instantly, background-fetch next batch",
        "Feed results (scores) posted back to Supabase after each item",
        "Offline fallback: cached items playable without network",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Added src/scripts/network/feed_sync.gd to fetch feed_items from Supabase in 50-item batches, cache feed snapshots/results under user://feed_cache/, and retry queued score uploads offline. Updated feed_main.gd to load cached snapshots instantly on app open, render immediately, and run a non-blocking background fetch for the next batch while preserving offline cached playability; score submissions now post via FeedSync after each completed item.",
      "dependsOn": [
        "US-009",
        "US-011"
      ]
    },
    {
      "id": "US-013",
      "title": "Full match battle mode",
      "description": "As a player, I want to play a full 5-8 turn battle with my own puff team so that I get deeper tactical engagement.",
      "acceptanceCriteria": [
        "src/scenes/battle/FullBattle.tscn extends the 1-turn system to multi-turn battles",
        "Team selection screen: pick 3-4 puffs from roster",
        "Win condition: eliminate all enemy puffs or control majority of tiles",
        "Battle log recorded as JSON for 'decisive moment' extraction",
        "Victory/defeat screen with rewards summary",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Added src/scenes/battle/FullBattle.tscn and src/scripts/battle/full_battle.gd for multi-turn (up to 8-turn) battle flow with roster selection (3-4 puffs), tile-control majority and elimination win checks, persisted JSON battle logs in user://battle_logs for downstream decisive-moment extraction, and a victory/defeat overlay with reward summary. Extended turn_manager.gd with auto_begin_turn_cycle plus begin_turn_cycle()/end_battle() hooks so FullBattle can run pre-battle selection and external objective-based endings cleanly. Verified by headless scene instantiation, a log-persistence smoke run, and HOME=/tmp Godot --check-only across all src/scripts/*.gd files.",
      "dependsOn": [
        "US-009"
      ]
    },
    {
      "id": "US-014",
      "title": "Decisive moment extraction",
      "description": "As the system, I want to identify the most impactful turn from a full battle so that it becomes a feed item for other players.",
      "acceptanceCriteria": [
        "src/scripts/utils/moment_extractor.gd analyzes battle logs",
        "Extraction criteria: HP swing >= 30%, unit knockout occurred, unique skill changed outcome",
        "Extracted moment is packaged as a feed-compatible snapshot",
        "Snapshot includes: map state before the turn, all puff positions, enemy intents, original player's action and result",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Added src/scripts/utils/moment_extractor.gd to analyze FullBattle logs and score decisive turns using HP swing >=30%, knockout occurrence, and unique-skill outcome impact criteria. Extended full_battle.gd turn logging with per-turn pre-action snapshots (map state + puff positions + enemy intents) and player action/result summaries sourced from new turn_manager.gd action_resolved telemetry. Verified all src/scripts/*.gd via headless Godot --check-only and validated extraction output with a headless smoke test that builds a feed-compatible decisive-moment snapshot.",
      "dependsOn": [
        "US-013"
      ]
    },
    {
      "id": "US-015",
      "title": "Async PvP system",
      "description": "As a player, I want to challenge other players' AI ghosts so that I get competitive gameplay without real-time networking.",
      "acceptanceCriteria": [
        "Opponent team + AI weights uploaded to Supabase after each battle",
        "Matchmaking: fetch opponents near player's ELO from leaderboards table",
        "Battle runs locally against opponent's AI ghost",
        "Results posted to Supabase, ELO updated",
        "Battle log available for decisive moment extraction",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Added src/scripts/network/pvp_async.gd for async PvP ghost upload, ELO-window matchmaking from leaderboards, Supabase result posting, and ELO updates. Integrated src/scripts/battle/full_battle.gd with pre-battle matchmaking to load opponent ghost team + AI weights for local execution, and post-battle sync to upload player ghost and submit PvP result updates while preserving battle-log persistence for moment extraction. Verified all src/scripts/*.gd via HOME=/tmp Godot --headless --check-only and validated async matchmaking roster resolution with a headless FullBattle smoke script.",
      "dependsOn": [
        "US-013",
        "US-011"
      ]
    },
    {
      "id": "US-016",
      "title": "Puff accessory and growth system",
      "description": "As a player, I want to level up my puffs and equip accessories so that I have progression goals.",
      "acceptanceCriteria": [
        "Puff XP and level system: XP from feed + battles, stat growth per level",
        "Accessory system: hat/scarf/ribbon slots with bonus effects",
        "Accessory visually changes puff sprite (overlay layer)",
        "Accessories stored as resources, equipped via puff_data",
        "Collection screen showing owned accessories",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 16,
      "passes": true,
      "notes": "Added accessory progression system with new AccessoryData resources (hat/scarf/ribbon bonuses), extended puff_data.gd with XP/level growth and effective stat accessors, and added PuffProgression autoload to grant XP from feed_item_completed + battle_ended signals and equip starter accessories per puff. Updated puff.gd/Puff.tscn to render equipped accessory overlays, wired player puff spawns in turn_manager.gd/feed_item.gd/full_battle.gd to use progression runtime PuffData, and added CollectionScreen.tscn + collection_screen.gd opened from FeedMain profile button to show owned accessories and puff growth status. Verified with HOME=/tmp Godot --headless --check-only across all src/scripts/*.gd, headless project boot (--quit), and a runtime smoke test (US016_SMOKE_OK) covering XP awards, overlay textures, and collection population.",
      "dependsOn": [
        "US-003"
      ]
    },
    {
      "id": "US-017",
      "title": "UGC puzzle editor",
      "description": "As a player, I want to create my own puzzle scenarios and share them so that the community generates content.",
      "acceptanceCriteria": [
        "src/scenes/ui/PuzzleEditor.tscn with drag-and-drop puff/terrain placement",
        "Place puffs on any tile, set their element/class/team",
        "Set win condition from templates",
        "Test-play before publishing",
        "Serialize to JSON and upload to ugc_puzzles table on Supabase",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Added src/scenes/ui/PuzzleEditor.tscn + src/scripts/ui/puzzle_editor.gd with drag terrain paint and puff drag/drop placement on the isometric board, including per-puff team/element/class controls and template-based win-condition selection. Integrated FeedMain Create FAB to open/close the editor, block feed swipe input while editing, and surface editor status/publish updates. Editor now enforces test-play before publish by running the authored snapshot through FeedItem and only allowing Supabase upload when the current snapshot hash matches the last completed test run; publish serializes to JSON-safe data and posts to the ugc_puzzles table via SupabaseClient request_rest(). Extended feed_item.gd snapshot spawning to honor optional puff element/puff_class overrides for editor-authored puzzles. Verified with HOME=/tmp Godot --check-only across all src/scripts/*.gd, headless project boot, and a runtime smoke script (US017_SMOKE_OK).",
      "dependsOn": [
        "US-010",
        "US-011"
      ]
    },
    {
      "id": "US-018",
      "title": "Squash & stretch animations",
      "description": "As a player, I want puffs to bounce, squish, and stretch during movement and combat so that the game feels alive and cute.",
      "acceptanceCriteria": [
        "src/scripts/ui/puff_animator.gd with squash_and_stretch tween functions",
        "Move: puff bounces along path tiles",
        "Attack: puff inflates briefly then squishes on impact",
        "Bump: pushed puff stretches in direction of push, bounces on landing",
        "Defeat: puff deflates (ppyu~ shrink) and fades out",
        "Heal: gentle glow + slight float-up",
        "All animations use Godot Tween system, configurable duration",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Added src/scripts/ui/puff_animator.gd with Tween-based squash/stretch functions for move, attack, bump, defeat, and heal (all with configurable durations). Integrated TurnManager action flow to play bounce movement paths, attack inflate/squish, directional bump stretch + landing bounce, defeat deflate/fade on knockouts, and heal glow/float feedback on cliff-stun recovery; added action-lock guards during animations. Verified via HOME=/tmp Godot --headless --check-only across all src/scripts/*.gd (22 scripts) and headless project boot (--quit).",
      "dependsOn": [
        "US-003"
      ]
    },
    {
      "id": "US-019",
      "title": "Score and comparison overlay",
      "description": "As a player, I want to see my score compared to the original player (for decisive moments) or community average so that I feel competitive.",
      "acceptanceCriteria": [
        "Score calculated from: enemies defeated, damage dealt, puffs surviving, turns used",
        "For decisive moments: 'Did you do better than the original player?' comparison",
        "For micro-puzzles: percentile ranking vs other players",
        "Animated score reveal (numbers counting up)",
        "Share button stub for future social features",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 19,
      "passes": true,
      "notes": "Implemented score/comparison overlay in src/scripts/feed/feed_item.gd with score components required by the story (enemies defeated, damage dealt, puffs surviving, turns used), animated count-up reveal, decisive-moment comparison text ('Did you do better than the original player?') driven by moment_meta snapshots, micro-puzzle community percentile ranking with metadata+sample fallback, and a Share button stub for future social integration. Re-ran HOME=/tmp Godot --headless --check-only across all src/scripts/*.gd.",
      "dependsOn": [
        "US-009"
      ]
    },
    {
      "id": "US-020",
      "title": "Story mode chapter 1",
      "description": "As a player, I want a guided story campaign to learn the game and meet puff characters.",
      "acceptanceCriteria": [
        "5-8 scripted battles with dialogue between them",
        "Introduces each puff class one at a time across battles",
        "Tutorial integrated: first 2 battles teach move/attack, 3rd teaches bump, 4th teaches terrain",
        "Simple dialogue system with character portraits",
        "Chapter completion rewards: unlock puffs + accessories",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 20,
      "passes": true,
      "notes": "Added src/scenes/story/StoryChapter1.tscn + src/scripts/story/story_chapter_1.gd with a 6-battle scripted Chapter 1 campaign, inter-battle dialogue with portrait cards, tutorial objectives in battles 1-4 (move/attack/bump/terrain), and chapter-complete reward flow that unlocks additional puff classes and new accessory resources via PuffProgression story reward claims. Extended FullBattle with start_scripted_battle(), battle_completed/player_action_resolved signals, and scripted-mode toggles for map/enemy roster overrides and async/result-overlay suppression; wired FeedMain leaderboard FAB to open StoryChapter1. Added chapter reward accessories (chapter_crown, story_sash), surfaced story lock status in collection snapshot/UI, and validated modified scripts/scenes via headless Godot checks.",
      "dependsOn": [
        "US-013",
        "US-018"
      ]
    },
    {
      "id": "US-021",
      "title": "Global visual theme system",
      "description": "As a developer, I want a shared visual theme autoload so that all screens use consistent GDD pastel/kawaii styling without duplication.",
      "acceptanceCriteria": [
        "src/scripts/core/visual_theme.gd exists as a new autoload singleton registered in project.godot",
        "VisualTheme provides: create_panel_stylebox(bg_color, corner_radius, border_color) returning StyleBoxFlat",
        "VisualTheme provides: create_button_styleboxes(base_color, font_color, corner_radius) returning Dictionary with normal/hover/pressed/disabled StyleBoxFlat entries",
        "VisualTheme provides: apply_button_theme(button, base_color, font_color, min_size, font_size) that fully styles a Button node",
        "VisualTheme provides: apply_label_theme(label, font_size, font_color) that styles a Label node",
        "VisualTheme provides: create_separator_stylebox(color, thickness) returning StyleBoxLine",
        "constants.gd has GDD palette colors: PALETTE_LAVENDER (#957DAD), PALETTE_MINT (#A8D8B9), PALETTE_PEACH (#FFD6BA), PALETTE_SKY (#A0C4FF), PALETTE_PINK (#E8A0BF)",
        "constants.gd has UI colors: COLOR_BG_CREAM, COLOR_BG_DARK_OVERLAY, COLOR_TEXT_DARK, COLOR_TEXT_LIGHT, COLOR_TEAM_PLAYER, COLOR_TEAM_ENEMY",
        "constants.gd has font size constants: FONT_SIZE_TITLE (38), FONT_SIZE_SUBTITLE (22), FONT_SIZE_BODY (18), FONT_SIZE_BUTTON (26), FONT_SIZE_HUD (20)",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 21,
      "passes": true,
      "notes": "Added src/scripts/core/visual_theme.gd with StyleBox/label/button helpers, registered it as VisualTheme autoload in project.godot, and added palette/font UI constants in src/scripts/core/constants.gd (PALETTE_* and COLOR_*/FONT_SIZE_*).",
      "dependsOn": ["US-001"]
    },
    {
      "id": "US-022",
      "title": "Puff visual upgrade with kawaii face and team ring",
      "description": "As a player, I want puffs to be bigger with cute faces and team-colored rings so that they are visually appealing and clearly team-identified.",
      "acceptanceCriteria": [
        "PLACEHOLDER_TEXTURE_SIZE increased from 72 to 128 and PLACEHOLDER_RADIUS from 26 to 48 in puff.gd",
        "Puff placeholder texture draws a kawaii face: two oval dark eyes at ~35% from top, small curved mouth at ~55% from top, two small pink blush circles on cheeks",
        "Puff placeholder texture draws a 3px team-colored ring around the outer edge (player=COLOR_TEAM_PLAYER blue, enemy=COLOR_TEAM_ENEMY red)",
        "Puff.gd accepts a team property or parameter to determine ring color during _build_placeholder_visual()",
        "Small colored diamond element badge drawn in the bottom-right corner of the puff texture using the element color",
        "Collision shape radius and sprite offset updated to match the new 128px size",
        "Accessory textures (hat/scarf/ribbon) scale proportionally to the new 128px size",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 22,
      "passes": true,
      "notes": "Updated src/scripts/puffs/puff.gd to size placeholder rendering at 128px with 48px radius, 3px team ring, kawaii eyes/mouth/blush, and element badge; accessory textures now scale from 72px coordinates; collision shape and offsets adjusted; added exported team field + set_team() and wired team assignment in turn_manager, feed_item, full_battle, and puzzle_editor spawn paths.",
      "dependsOn": ["US-021"]
    },
    {
      "id": "US-023",
      "title": "Isometric tilemap terrain indicator symbols",
      "description": "As a player, I want distinct visual indicators on each terrain tile so that I can tell cloud from cliff at a glance.",
      "acceptanceCriteria": [
        "Each terrain type in _draw_isometric_diamond() draws a pixel-art indicator symbol on the tile center: cloud=small white circle puff, high_cloud=upward arrow pixels, cotton_candy=spiral/swirl pattern, puddle=wavy horizontal lines, cliff=downward-pointing triangle, mushroom=mushroom cap silhouette",
        "Tiles have a subtle gradient: top half slightly lighter, bottom half slightly darker for 3D depth",
        "Cliff tiles have a thicker/darker border for danger emphasis",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 23,
      "passes": true,
      "notes": "Updated src/scripts/core/battle_map.gd to add gradient shading in tile diamonds and per-terrain center pixel-art symbols (cloud puff, high-cloud upward arrow, cotton-candy swirl, puddle wavy lines, cliff downward triangle, mushroom silhouette). Cliff tiles now use a darker, thicker border threshold for danger emphasis.",
      "dependsOn": ["US-021"]
    },
    {
      "id": "US-024",
      "title": "Feed UI redesign with themed labels and swipe hint",
      "description": "As a player, I want the feed screen to look polished with styled titles, themed FAB buttons, and a swipe hint so that the first impression is premium.",
      "acceptanceCriteria": [
        "Title label uses VisualTheme.apply_label_theme with FONT_SIZE_TITLE and COLOR_TEXT_DARK",
        "Subtitle label uses VisualTheme.apply_label_theme with FONT_SIZE_SUBTITLE and a slightly muted color",
        "FAB buttons (Profile, Create, Leaderboard) use VisualTheme.apply_button_theme with GDD palette colors: Profile=PALETTE_SKY, Create=PALETTE_PEACH, Leaderboard=PALETTE_MINT",
        "A SwipeHintLabel node exists showing upward swipe indicator text at the bottom center of the feed",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 24,
      "passes": true,
      "notes": "FeedMain.tscn now includes SwipeHintLabel and FeedMain script applies VisualTheme.apply_label_theme to title/subtitle/swipe hint plus palette-based themed FAB buttons via VisualTheme.apply_button_theme. Title/subtitle fonts now come from constants.",
      "dependsOn": ["US-021"]
    },
    {
      "id": "US-025",
      "title": "Battle HUD with turn banner and result overlay",
      "description": "As a player, I want a battle HUD showing turn state and results so that I understand what is happening during combat.",
      "acceptanceCriteria": [
        "TurnBattle.tscn has a new HudLayer (CanvasLayer) child with TurnBanner (Label), ScorePanel (PanelContainer), and ResultOverlay (ColorRect) nodes",
        "src/scripts/ui/battle_hud.gd exists as the script on HudLayer, connecting to TurnManager signals",
        "TurnBanner displays 'Your Turn' or 'Enemy Turn' as a styled pill-shaped label (lavender bg, white text) during phase changes",
        "ResultOverlay shows 'Victory!' or 'Defeat' with a semi-transparent dark overlay when battle ends",
        "HUD elements are styled using VisualTheme helpers with GDD palette colors",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 25,
      "passes": true,
      "notes": "Added HUD to TurnBattle.tscn with CanvasLayer/HudLayer and TurnBanner, ScorePanel, ResultOverlay nodes. Created src/scripts/ui/battle_hud.gd on HudLayer to drive UI from TurnManager phase_changed and battle_ended signals, showing turn banners ('Your Turn', 'Enemy Turn', 'Resolving...') and victory/defeat result overlay. Styled HUD elements via VisualTheme helpers and GDD palette constants, and added TurnManager.battle_ended(StringName) signal to support battle completion HUD state.",
      "dependsOn": ["US-021"]
    },
    {
      "id": "US-026",
      "title": "Enhanced enemy intent visualization with arrows",
      "description": "As a player, I want colored arrows and cell highlights for enemy intents so that the Into-the-Breach-style preview is visually clear.",
      "acceptanceCriteria": [
        "Enemy intent move actions draw a colored arrow line from actor cell to destination cell (yellow/gold color)",
        "Enemy intent attack actions draw a red semi-transparent overlay on the target cell with a crosshair/X symbol",
        "Enemy intent skill/bump actions draw an orange arrow from actor to target with skill area cells highlighted in purple",
        "Arrow heads are visible and properly oriented toward the target direction",
        "Intent colors are more vivid and distinguishable than the current implementation",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 26,
      "passes": true,
      "notes": "Updated src/scripts/ai/enemy_intent.gd to use vivid yellow/gold move arrows, red semi-transparent attack targets with X/crosshair marks, orange skill arrows from actor to target, and purple skill-area highlighting with visible arrow heads and directionally oriented overlays.",
      "dependsOn": ["US-021"]
    },
    {
      "id": "US-027",
      "title": "Collection and editor screen styling",
      "description": "As a player, I want the collection and puzzle editor screens to use themed panels and buttons so that all screens feel visually consistent.",
      "acceptanceCriteria": [
        "CollectionScreen applies VisualTheme.create_panel_stylebox() to its Panel node with cream bg and rounded corners",
        "CollectionScreen title label uses FONT_SIZE_TITLE with PALETTE_LAVENDER color",
        "CollectionScreen CloseButton uses apply_button_theme with PALETTE_PINK",
        "PuzzleEditor Panel uses a themed panel stylebox",
        "PuzzleEditor buttons use themed styling: Apply=PALETTE_SKY, Remove=PALETTE_PINK, Clear=PALETTE_PEACH, TestPlay=PALETTE_MINT, Publish=PALETTE_LAVENDER",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 27,
      "passes": true,
      "notes": "Added _apply_themed_styles() in src/scripts/ui/collection_screen.gd and src/scripts/ui/puzzle_editor.gd. Collection now applies themed cream panel, lavender title text, and pink CloseButton; PuzzleEditor applies themed panel and Apply/Remove/Clear/TestPlay/Publish button colors via VisualTheme helpers.",
      "dependsOn": ["US-021"]
    },
    {
      "id": "US-028",
      "title": "Story dialogue and chapter complete styling",
      "description": "As a player, I want story dialogue panels and chapter complete overlays to use themed kawaii styling so that the narrative feels polished.",
      "acceptanceCriteria": [
        "DialoguePanel uses VisualTheme.create_panel_stylebox() with COLOR_BG_CREAM bg and rounded corners",
        "SpeakerLabel uses PALETTE_LAVENDER color and bold-sized font",
        "LineLabel uses COLOR_TEXT_DARK and comfortable font size",
        "NextButton uses apply_button_theme with PALETTE_MINT (pill shape)",
        "TutorialPanel uses VisualTheme.create_panel_stylebox() with PALETTE_SKY bg and white text",
        "ChapterCompleteOverlay ChapterPanel uses PALETTE_PEACH bg",
        "CompleteButton uses apply_button_theme with PALETTE_LAVENDER",
        "All .gd scripts have no syntax errors"
      ],
      "priority": 28,
      "passes": false,
      "notes": "",
      "dependsOn": ["US-021"]
    }
  ]
}
